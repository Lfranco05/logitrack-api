<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <title>LogiTrack ‚Äì Dashboard Moderno</title>

    <!-- Tipograf√≠a moderna -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

    <style>
        * {
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }

        body {
            margin: 0;
            background: #F3F4F6;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* ------- SIDEBAR ------- */
        #sidebar {
            width: 250px;
            background: #111827;
            color: #e5e7eb;
            display: flex;
            flex-direction: column;
            padding: 20px 15px;
        }

        #sidebar h2 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 25px;
            color: #fff;
        }

        .nav-btn {
            padding: 12px 14px;
            text-align: left;
            border: none;
            background: transparent;
            color: #d1d5db;
            cursor: pointer;
            width: 100%;
            border-radius: 8px;
            font-size: 15px;
            transition: 0.2s;
        }

        .nav-btn:hover {
            background: #1f2937;
        }

        .nav-btn.active {
            background: #3B82F6;
            color: white;
        }

        /* ------- CONTENIDO ------- */
        #content {
            flex: 1;
            overflow-y: auto;
            padding: 25px 40px;
        }

        h1 {
            margin-top: 0;
            color: #1f2937;
            font-size: 26px;
        }

        section {
            display: none;
            animation: fade 0.2s ease-in;
        }

        section.active {
            display: block;
        }

        @keyframes fade {
            from { opacity: 0 }
            to { opacity: 1 }
        }

        .card {
            background: white;
            padding: 20px;
            border-radius: 14px;
            margin-bottom: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }

        .card h3 {
            margin-top: 0;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 10px;
            font-size: 18px;
            color: #374151;
        }

        label {
            display: block;
            margin-top: 10px;
            font-size: 14px;
            color: #4b5563;
        }

        input[type="text"],
        input[type="number"],
        input[type="email"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            margin-top: 6px;
            font-size: 14px;
        }

        input[type="checkbox"] {
            transform: scale(1.2);
            margin-right: 8px;
        }

        .row {
            display: flex;
            gap: 15px;
        }

        .row > div {
            flex: 1;
        }

        /* ------- BOTONES ------- */
        button.primary {
            background: #3B82F6;
            color: white;
            padding: 10px 18px;
            border-radius: 10px;
            border: none;
            margin-top: 15px;
            cursor: pointer;
            font-size: 14px;
            transition: 0.2s;
        }

        button.primary:hover {
            background: #2563eb;
        }

        button.secondary {
            background: #6B7280;
            color: white;
            padding: 8px 14px;
            border-radius: 8px;
            border: none;
            margin-top: 10px;
            cursor: pointer;
            font-size: 13px;
        }

        /* ------- TABLAS ------- */
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
            margin-top: 10px;
        }

        table thead {
            background: #E5E7EB;
        }

        th, td {
            padding: 10px;
            border-bottom: 1px solid #d1d5db;
        }

        tr:hover {
            background: #f9fafb;
        }

        /* ------- LOG ------- */
        #log {
            position: fixed;
            bottom: 15px;
            right: 15px;
            padding: 10px 15px;
            background: #111827;
            color: #d1d5db;
            border-radius: 8px;
            font-size: 12px;
            max-width: 320px;
            max-height: 160px;
            overflow: auto;
        }
    </style>
</head>

<body>

<!-- SIDEBAR -->
<div id="sidebar">
    <h2>üì¶ LogiTrack</h2>

    <button class="nav-btn active" onclick="showSection('secProducts', this)">Productos</button>
    <button class="nav-btn" onclick="showSection('secCustomers', this)">Clientes</button>
    <button class="nav-btn" onclick="showSection('secOrders', this)">√ìrdenes</button>
    <button class="nav-btn" onclick="showSection('secPayments', this)">Pagos</button>
    <button class="nav-btn" onclick="showSection('secReports', this)">Reportes</button>
</div>

<!-- CONTENIDO -->
<div id="content">
    <h1>Panel Administrativo</h1>

    <!-- ================== PRODUCTOS ================== -->
    <section id="secProducts" class="active">
        <div class="card">
            <h3>Nuevo / Editar producto</h3>
            <input type="hidden" id="prodId" />

            <div class="row">
                <div>
                    <label>Nombre</label>
                    <input type="text" id="prodName" />
                </div>
                <div>
                    <label>Categor√≠a</label>
                    <input type="text" id="prodCategory" />
                </div>
            </div>

            <label>Descripci√≥n</label>
            <input type="text" id="prodDescription" />

            <div class="row">
                <div>
                    <label>Precio</label>
                    <input type="number" id="prodPrice" step="0.01" />
                </div>
                <div style="display:flex;align-items:center;margin-top:32px;">
                    <label style="margin:0;">
                        <input type="checkbox" id="prodActive" checked />
                        Activo
                    </label>
                </div>
            </div>

            <button class="primary" onclick="saveProduct()">Guardar producto</button>
            <button class="secondary" onclick="clearProductForm()">Limpiar formulario</button>
        </div>

        <div class="card">
            <h3>Listado de productos</h3>
            <button class="secondary" onclick="loadProducts()">Cargar productos</button>

            <table id="tblProducts">
                <thead>
                <tr>
                    <th>ID</th><th>Nombre</th><th>Categor√≠a</th><th>Precio</th><th>Activo</th><th>Acciones</th>
                </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </section>

    <!-- ================== CLIENTES ================== -->
    <section id="secCustomers">
        <div class="card">
            <h3>Nuevo / Editar cliente</h3>
            <input type="hidden" id="custId" />

            <label>Nombre completo</label>
            <input type="text" id="custFullName" />

            <label>NIT / Tax ID</label>
            <input type="text" id="custTaxId" />

            <div class="row">
                <div>
                    <label>Email</label>
                    <input type="email" id="custEmail" />
                </div>
                <div>
                    <label>Direcci√≥n</label>
                    <input type="text" id="custAddress" />
                </div>
            </div>

            <label>
                <input type="checkbox" id="custActive" checked />
                Activo
            </label>

            <button class="primary" onclick="saveCustomer()">Guardar cliente</button>
            <button class="secondary" onclick="clearCustomerForm()">Limpiar formulario</button>
        </div>

        <div class="card">
            <h3>Listado de clientes</h3>
            <button class="secondary" onclick="loadCustomers()">Cargar clientes</button>

            <table id="tblCustomers">
                <thead>
                <tr>
                    <th>ID</th><th>Nombre</th><th>NIT</th><th>Email</th><th>Activo</th><th>Acciones</th>
                </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </section>

    <!-- ================== √ìRDENES ================== -->
    <section id="secOrders">
        <div class="card">
            <h3>Crear orden</h3>
            <label>ID Cliente</label>
            <input type="number" id="ordCustomerId" />
            <button class="primary" onclick="createOrder()">Crear orden</button>
        </div>

        <div class="card">
            <h3>Agregar √≠tem a orden</h3>

            <div class="row">
                <div>
                    <label>ID Orden</label>
                    <input type="number" id="ordItemOrderId" />
                </div>
                <div>
                    <label>ID Producto</label>
                    <input type="number" id="ordItemProductId" />
                </div>
                <div>
                    <label>Cantidad</label>
                    <input type="number" id="ordItemQuantity" />
                </div>
            </div>

            <button class="primary" onclick="addOrderItem()">Agregar √≠tem</button>
        </div>

        <div class="card">
            <h3>Cambiar estado de orden</h3>

            <div class="row">
                <div>
                    <label>ID Orden</label>
                    <input type="number" id="ordStatusOrderId" />
                </div>
                <div>
                    <label>Nuevo estado</label>
                    <input type="text" id="ordStatusNew" placeholder="Pending, Completed, Cancelled..." />
                </div>
            </div>

            <button class="primary" onclick="changeOrderStatus()">Cambiar estado</button>
        </div>

        <div class="card">
            <h3>Listado de √≥rdenes</h3>
            <button class="secondary" onclick="loadOrders()">Cargar √≥rdenes</button>

            <table id="tblOrders">
                <thead>
                <tr>
                    <th>ID</th><th>Cliente</th><th>Fecha</th><th>Estado</th><th>Total</th>
                </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </section>

    <!-- ================== PAGOS ================== -->
    <section id="secPayments">
        <div class="card">
            <h3>Registrar pago</h3>

            <div class="row">
                <div>
                    <label>ID Orden</label>
                    <input type="number" id="payOrderId" />
                </div>
                <div>
                    <label>Monto</label>
                    <input type="number" id="payAmount" step="0.01" />
                </div>
                <div>
                    <label>M√©todo</label>
                    <input type="text" id="payMethod" placeholder="cash, card, transfer..." />
                </div>
            </div>

            <button class="primary" onclick="registerPayment()">Registrar pago</button>
        </div>

        <div class="card">
            <h3>Pagos por orden</h3>
            <label>ID Orden</label>
            <input type="number" id="paySearchOrderId" />
            <button class="secondary" onclick="loadPaymentsByOrder()">Ver pagos</button>

            <table id="tblPayments">
                <thead>
                <tr>
                    <th>ID</th><th>Monto</th><th>M√©todo</th><th>Fecha</th>
                </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </section>

    <!-- ================== REPORTES ================== -->
    <section id="secReports">
        <div class="card">
            <h3>Top productos m√°s vendidos</h3>

            <label>L√≠mite</label>
            <input type="number" id="repLimit" value="10" />

            <button class="primary" onclick="loadTopProducts()">Cargar reporte</button>

            <table id="tblTopProducts">
                <thead>
                <tr>
                    <th>ID</th><th>Nombre</th><th>Categor√≠a</th><th>Cantidad vendida</th>
                </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </section>

</div>


<!-- ================== JAVASCRIPT ORIGINAL ================== -->
<div id="log">Listo.</div>

<script>
    const API_BASE = 'api';

    function log(msg) {
        const logDiv = document.getElementById('log');
        const now = new Date().toLocaleTimeString();
        logDiv.textContent = '[' + now + '] ' + msg;
    }

    function showSection(id, btn) {
        document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');

        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }

    // UTIL
    async function apiRequest(path, options = {}) {
        const url = API_BASE + path;
        const defaultHeaders = { 'Content-Type': 'application/json' };
        const opts = Object.assign({ headers: defaultHeaders }, options);

        try {
            const resp = await fetch(url, opts);
            if (!resp.ok) {
                const text = await resp.text();
                throw new Error('HTTP ' + resp.status + ' - ' + text);
            }
            if (resp.status === 204) return null;
            const ct = resp.headers.get('Content-Type') || '';
            if (ct.includes('application/json')) return await resp.json();
            return await resp.text();
        } catch (e) {
            log('Error: ' + e.message);
            alert('Error: ' + e.message);
            throw e;
        }
    }

    // PRODUCTOS
    async function loadProducts() {
        const data = await apiRequest('/products', { method: 'GET' });
        const tbody = document.querySelector('#tblProducts tbody');
        tbody.innerHTML = '';
        data.forEach(p => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${p.productId}</td>
                <td>${p.name}</td>
                <td>${p.category || ''}</td>
                <td>${p.price}</td>
                <td>${p.active ? 'S√≠' : 'No'}</td>
                <td>
                    <button class="secondary" onclick='editProduct(${JSON.stringify(p).replace(/"/g, "&quot;")})'>Editar</button>
                    <button class="secondary" onclick='toggleProductStatus(${p.productId}, ${p.active})'>
                        ${p.active ? 'Desactivar' : 'Activar'}
                    </button>
                </td>
            `;
            tbody.appendChild(tr);
        });
        log('Productos cargados (' + data.length + ').');
    }

    function editProduct(p) {
        document.getElementById('prodId').value = p.productId;
        document.getElementById('prodName').value = p.name || '';
        document.getElementById('prodCategory').value = p.category || '';
        document.getElementById('prodDescription').value = p.description || '';
        document.getElementById('prodPrice').value = p.price || '';
        document.getElementById('prodActive').checked = !!p.active;
    }

    function clearProductForm() {
        document.getElementById('prodId').value = '';
        document.getElementById('prodName').value = '';
        document.getElementById('prodCategory').value = '';
        document.getElementById('prodDescription').value = '';
        document.getElementById('prodPrice').value = '';
        document.getElementById('prodActive').checked = true;
    }

    async function saveProduct() {
        const id = document.getElementById('prodId').value;
        const body = {
            name: document.getElementById('prodName').value,
            category: document.getElementById('prodCategory').value,
            description: document.getElementById('prodDescription').value,
            price: parseFloat(document.getElementById('prodPrice').value || '0'),
            active: document.getElementById('prodActive').checked
        };
        if (!body.name) { alert('El nombre es obligatorio'); return; }

        if (id) {
            await apiRequest('/products/' + id, {
                method: 'PUT',
                body: JSON.stringify(body)
            });
            log('Producto actualizado (ID ' + id + ').');
        } else {
            await apiRequest('/products', {
                method: 'POST',
                body: JSON.stringify(body)
            });
            log('Producto creado.');
        }

        clearProductForm();
        loadProducts();
    }

    async function toggleProductStatus(id, current) {
        const newStatus = !current;
        await apiRequest('/products/' + id + '/status?active=' + newStatus, {
            method: 'PATCH'
        });
        log('Estado cambiado.');
        loadProducts();
    }

    // CLIENTES
    async function loadCustomers() {
        const data = await apiRequest('/customers', { method: 'GET' });
        const tbody = document.querySelector('#tblCustomers tbody');
        tbody.innerHTML = '';
        data.forEach(c => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${c.customerId}</td>
                <td>${c.fullName}</td>
                <td>${c.taxId || ''}</td>
                <td>${c.email || ''}</td>
                <td>${c.active ? 'S√≠' : 'No'}</td>
                <td>
                    <button class="secondary" onclick='editCustomer(${JSON.stringify(c).replace(/"/g, "&quot;")})'>Editar</button>
                    <button class="secondary" onclick='toggleCustomerStatus(${c.customerId}, ${c.active})'>
                        ${c.active ? 'Desactivar' : 'Activar'}
                    </button>
                </td>
            `;
            tbody.appendChild(tr);
        });
        log('Clientes cargados.');
    }

    function editCustomer(c) {
        document.getElementById('custId').value = c.customerId;
        document.getElementById('custFullName').value = c.fullName || '';
        document.getElementById('custTaxId').value = c.taxId || '';
        document.getElementById('custEmail').value = c.email || '';
        document.getElementById('custAddress').value = c.address || '';
        document.getElementById('custActive').checked = !!c.active;
    }

    function clearCustomerForm() {
        document.getElementById('custId').value = '';
        document.getElementById('custFullName').value = '';
        document.getElementById('custTaxId').value = '';
        document.getElementById('custEmail').value = '';
        document.getElementById('custAddress').value = '';
        document.getElementById('custActive').checked = true;
    }

    async function saveCustomer() {
        const id = document.getElementById('custId').value;
        const body = {
            fullName: document.getElementById('custFullName').value,
            taxId: document.getElementById('custTaxId').value,
            email: document.getElementById('custEmail').value,
            address: document.getElementById('custAddress').value,
            active: document.getElementById('custActive').checked
        };

        if (!body.fullName) { alert('El nombre es obligatorio'); return; }

        if (id) {
            await apiRequest('/customers/' + id, { method: 'PUT', body: JSON.stringify(body) });
            log('Cliente actualizado.');
        } else {
            await apiRequest('/customers', { method: 'POST', body: JSON.stringify(body) });
            log('Cliente creado.');
        }

        clearCustomerForm();
        loadCustomers();
    }

    async function toggleCustomerStatus(id, current) {
        const newStatus = !current;
        await apiRequest('/customers/' + id + '/status?active=' + newStatus, {
            method: 'PATCH'
        });
        loadCustomers();
    }

    // ORDENES
    async function createOrder() {
        const cid = parseInt(document.getElementById('ordCustomerId').value || '0');
        if (!cid) return alert("ID de cliente requerido.");

        const order = await apiRequest('/orders', {
            method: 'POST',
            body: JSON.stringify({ customerId: cid })
        });

        log("Orden creada ID: " + order.orderId);
        loadOrders();
    }

    async function addOrderItem() {
        const orderId = parseInt(ordItemOrderId.value || '0');
        const productId = parseInt(ordItemProductId.value || '0');
        const qty = parseInt(ordItemQuantity.value || '0');

        if (!orderId || !productId || !qty) return alert("Todos los campos son obligatorios.");

        await apiRequest(`/orders/${orderId}/items`, {
            method: 'POST',
            body: JSON.stringify({ productId, quantity: qty })
        });

        log("√çtem agregado.");
        loadOrders();
    }

    async function changeOrderStatus() {
        const orderId = parseInt(ordStatusOrderId.value || '0');
        const status = ordStatusNew.value;

        if (!orderId || !status) return alert("Campos obligatorios.");

        await apiRequest(`/orders/${orderId}/status`, {
            method: 'PATCH',
            body: JSON.stringify({ status })
        });

        log("Estado cambiado.");
        loadOrders();
    }

    async function loadOrders() {
        const data = await apiRequest('/orders', { method: 'GET' });
        const tbody = document.querySelector('#tblOrders tbody');
        tbody.innerHTML = '';

        data.forEach(o => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${o.orderId}</td>
                <td>${o.customer ? o.customer.fullName : ''}</td>
                <td>${o.orderDate}</td>
                <td>${o.status}</td>
                <td>${o.totalAmount}</td>
            `;
            tbody.appendChild(tr);
        });

        log("√ìrdenes cargadas.");
    }

    // PAGOS
    async function registerPayment() {
        const orderId = parseInt(payOrderId.value || '0');
        const amount = parseFloat(payAmount.value || '0');
        const method = payMethod.value;

        if (!orderId || !amount || !method) return alert("Campos obligatorios.");

        await apiRequest('/payments', {
            method: 'POST',
            body: JSON.stringify({ orderId, amount, method })
        });

        log("Pago registrado.");
    }

    async function loadPaymentsByOrder() {
        const orderId = parseInt(paySearchOrderId.value || '0');
        if (!orderId) return alert("Ingrese ID de orden.");

        const data = await apiRequest(`/payments/by-order/${orderId}`);

        const tbody = document.querySelector('#tblPayments tbody');
        tbody.innerHTML = '';

        data.forEach(p => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${p.paymentId}</td>
                <td>${p.amount}</td>
                <td>${p.method}</td>
                <td>${p.paymentDate}</td>
            `;
            tbody.appendChild(tr);
        });

        log("Pagos cargados.");
    }

    // REPORTES
    async function loadTopProducts() {
        const limit = parseInt(repLimit.value || '10');

        const data = await apiRequest(`/reports/top-products?limit=${limit}`);

        const tbody = document.querySelector('#tblTopProducts tbody');
        tbody.innerHTML = '';

        data.forEach(row => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${row.productId}</td>
                <td>${row.name}</td>
                <td>${row.category || ''}</td>
                <td>${row.totalQuantity}</td>
            `;
            tbody.appendChild(tr);
        });

        log("Reporte cargado.");
    }

    // CARGA INICIAL
    loadProducts();
</script>

</body>
</html>